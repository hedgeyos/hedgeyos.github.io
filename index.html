<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>HedgeyOS</title>
  <style>
    :root{
      --bg: #cfcfcf;
      --menubar-bg:#e6e6e6;
      --menubar-border-dark:#7a7a7a;
      --menubar-border-light:#ffffff;

      --menu-bg:#f2f2f2;
      --menu-border:#5b5b5b;
      --menu-text:#111;
      --menu-hover:#2b67c7;
      --menu-hover-text:#fff;
      --menu-sep:#a8a8a8;

      --win-bg:#efefef;
      --win-border:#404040;
      --win-highlight:#ffffff;
      --win-shadow:#8a8a8a;

      --titlebar-bg:#dcdcdc;
      --titlebar-text:#111;

      --btn-bg:#dedede;
      --btn-border:#444;
      --btn-shadow:#fff;

      --field-bg:#ffffff;
      --field-border:#555;
      --field-text:#111;

      --status-text:#111;

      --accent:#2b67c7;
      --desktop-icon-text:#111;

      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sys: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      --menubar-h: 28px;
      --win-radius: 0px;
      --win-title-h: 26px;
    }

    [data-theme="dark"]{
      --bg:#23262b;
      --menubar-bg:#2b2f35;
      --menubar-border-dark:#111;
      --menubar-border-light:#3b4048;

      --menu-bg:#2f343c;
      --menu-border:#101215;
      --menu-text:#f2f2f2;
      --menu-hover:#2b67c7;
      --menu-hover-text:#fff;
      --menu-sep:#4b505a;

      --win-bg:#2a2e34;
      --win-border:#101215;
      --win-highlight:#3b4048;
      --win-shadow:#0a0b0d;

      --titlebar-bg:#30363f;
      --titlebar-text:#f2f2f2;

      --btn-bg:#323944;
      --btn-border:#0b0d10;
      --btn-shadow:#46505f;

      --field-bg:#1f2329;
      --field-border:#0b0d10;
      --field-text:#f2f2f2;

      --status-text:#d8d8d8;
      --desktop-icon-text:#f2f2f2;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--menu-text);
      font-family: var(--sys);
      overflow:hidden;
      -webkit-font-smoothing: none;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }

    /* Desktop */
    #desktop{
      position:fixed;
      inset:0;
      background:var(--bg);
      overflow:hidden;
    }

    #desktop-icons{
      position:absolute;
      inset: var(--menubar-h) 0 0 0;
      pointer-events:none;
    }

    .desktop-icon{
      position:absolute;
      width:86px;
      pointer-events:auto;
      user-select:none;
      -webkit-user-select:none;
      text-align:center;
      cursor:default;
    }
    .desktop-icon .emoji{
      font-size:34px;
      line-height:36px;
      filter: drop-shadow(0 1px 0 rgba(255,255,255,0.35));
    }
    [data-theme="dark"] .desktop-icon .emoji{
      filter: drop-shadow(0 1px 0 rgba(0,0,0,0.5));
    }
    .desktop-icon .label{
      margin-top:2px;
      font-size:12px;
      line-height:13px;
      color:var(--desktop-icon-text);
      text-shadow: 0 1px 0 rgba(255,255,255,0.35);
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
      word-break: break-word;
      padding:0 4px;
    }
    [data-theme="dark"] .desktop-icon .label{
      text-shadow: 0 1px 0 rgba(0,0,0,0.6);
    }

    /* Menubar */
    #menubar{
      position:absolute;
      left:0; right:0; top:0;
      height:var(--menubar-h);
      background:var(--menubar-bg);
      display:flex;
      align-items:stretch;
      padding:0 6px;
      box-sizing:border-box;
      border-top:1px solid var(--menubar-border-light);
      border-bottom:1px solid var(--menubar-border-dark);
      user-select:none;
      -webkit-user-select:none;
      z-index:10000;
    }

    .menu-left{
      display:flex;
      gap:2px;
      align-items:stretch;
      flex: 1 1 auto;
      min-width:0;
    }
    .menu-right{
      display:flex;
      align-items:center;
      gap:6px;
    }

    .menu{
      position:relative;
      display:flex;
      align-items:center;
      padding:0 10px;
      font-size:14px;
      color:var(--menu-text);
      cursor:default;
      white-space:nowrap;
    }
    .menu.active{
      background: var(--accent);
      color:#fff;
    }
    .menu .logo{
      font-size:16px;
      line-height:16px;
      transform: translateY(-1px);
    }

    .dropdown{
      position:absolute;
      top: calc(var(--menubar-h) - 1px);
      left:0;
      min-width: 220px;
      background: var(--menu-bg);
      border:1px solid var(--menu-border);
      box-shadow: 1px 1px 0 rgba(0,0,0,0.25);
      padding:6px 0;
      display:none;
      z-index:10001;
      color: var(--menu-text);
    }
    .menu.active .dropdown{ display:block; }

    .item, .heading{
      padding:6px 14px;
      font-size:14px;
      line-height:16px;
      color: var(--menu-text);
      white-space:nowrap;
    }
    .heading{
      opacity:0.75;
      font-size:12px;
      padding-top:8px;
      padding-bottom:4px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .item{
      cursor:default;
    }
    .item:hover{
      background: var(--menu-hover);
      color: var(--menu-hover-text);
    }
    .item.disabled{
      opacity:0.5;
      pointer-events:none;
    }
    .sep{
      height:1px;
      background: var(--menu-sep);
      margin:6px 0;
    }

    .toggle-btn{
      width:26px;
      height:22px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: var(--btn-bg);
      border:1px solid var(--btn-border);
      box-shadow: inset 1px 1px 0 var(--btn-shadow);
      font-size:14px;
      cursor:default;
      user-select:none;
      -webkit-user-select:none;
    }

    /* Windows */
    #windows{
      position:absolute;
      inset: var(--menubar-h) 0 0 0;
      z-index:5;
    }

    .window{
      position:absolute;
      background: var(--win-bg);
      border:1px solid var(--win-border);
      box-shadow:
        inset 1px 1px 0 var(--win-highlight),
        inset -1px -1px 0 var(--win-shadow);
      border-radius: var(--win-radius);
      overflow:hidden;
      touch-action:none;
    }
    .window.inactive{
      filter: saturate(0.8);
    }

    .titlebar{
      height: var(--win-title-h);
      background: var(--titlebar-bg);
      border-bottom:1px solid var(--win-border);
      display:flex;
      align-items:center;
      gap:8px;
      padding:0 8px;
      box-sizing:border-box;
      cursor: grab;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
    }
    .titlebar:active{ cursor: grabbing; }
    .titlebar .controls{
      display:flex;
      gap:6px;
      align-items:center;
      min-width:42px;
    }
    .ctrl{
      width:14px;
      height:14px;
      border:1px solid var(--win-border);
      background: var(--btn-bg);
      box-shadow: inset 1px 1px 0 var(--btn-shadow);
    }

    .titlebar .center-title{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      color: var(--titlebar-text);
      font-weight:600;
      font-size:14px;
      letter-spacing:0.2px;
    }
    .titlebar .center-title .lines{
      position:absolute;
      left:8px; right:8px;
      height:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      pointer-events:none;
    }
    .lineblock{
      width:38%;
      height:10px;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.65) 0px,
          rgba(255,255,255,0.65) 1px,
          rgba(0,0,0,0.10) 2px,
          rgba(0,0,0,0.10) 3px
        );
      opacity:0.65;
      filter: contrast(0.9);
    }
    [data-theme="dark"] .lineblock{
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.25) 0px,
          rgba(255,255,255,0.25) 1px,
          rgba(0,0,0,0.55) 2px,
          rgba(0,0,0,0.55) 3px
        );
      opacity:0.85;
    }
    .title-text{
      background: var(--titlebar-bg);
      padding:0 8px;
      z-index:2;
      max-width:70%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .window-inner{
      display:flex;
      flex-direction:column;
      height: calc(100% - var(--win-title-h));
      min-height:0;
    }

    .window-body{
      flex:1 1 auto;
      min-height:0;
      position:relative;
      padding:10px;
      box-sizing:border-box;
      overflow:hidden;
    }

    .statusbar{
      flex: 0 0 auto;
      height:22px;
      border-top:1px solid var(--win-border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      font-size:13px;
      color: var(--status-text);
      box-sizing:border-box;
      background: rgba(255,255,255,0.18);
    }
    [data-theme="dark"] .statusbar{
      background: rgba(0,0,0,0.15);
    }

    .resize-handle{
      position:absolute;
      right:2px;
      bottom:2px;
      width:18px;
      height:18px;
      cursor:nwse-resize;
      background:
        repeating-linear-gradient(
          135deg,
          rgba(0,0,0,0.25) 0px,
          rgba(0,0,0,0.25) 1px,
          rgba(255,255,255,0.25) 2px,
          rgba(255,255,255,0.25) 3px
        );
      opacity:0.75;
      border-left:1px solid rgba(0,0,0,0.12);
      border-top:1px solid rgba(0,0,0,0.12);
      touch-action:none;
      z-index: 50;
    }
    [data-theme="dark"] .resize-handle{
      opacity:0.9;
    }

    .btn{
      background: var(--btn-bg);
      border:1px solid var(--btn-border);
      box-shadow: inset 1px 1px 0 var(--btn-shadow);
      padding:4px 10px;
      font-size:14px;
      cursor:default;
      user-select:none;
      -webkit-user-select:none;
    }

    .field{
      background: var(--field-bg);
      border:1px solid var(--field-border);
      color: var(--field-text);
      padding:6px 8px;
      font-size:14px;
      outline:none;
      box-sizing:border-box;
      font-family: var(--sys);
    }

    /* Files window content */
    .files-wrap{
      display:flex;
      flex-direction:column;
      height:100%;
      min-height:0;
      gap:8px;
    }
    .files-toolbar{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .files-grid{
      border:1px solid var(--win-border);
      background: rgba(255,255,255,0.12);
      display:flex;
      flex-direction:column;
      min-height:0;
      flex:1 1 auto;
    }
    .files-header{
      display:flex;
      border-bottom:1px solid rgba(0,0,0,0.25);
      background: rgba(255,255,255,0.14);
      font-weight:700;
      font-size:14px;
    }
    .files-header div{
      padding:6px 8px;
    }
    .col-name{ flex: 1 1 auto; }
    .files-list{
      flex: 1 1 auto;
      min-height:0;
      overflow:auto;
      background: rgba(255,255,255,0.06);
    }
    .row{
      padding:8px 10px;
      border-bottom:1px solid rgba(0,0,0,0.08);
      font-size:14px;
      cursor:default;
      user-select:none;
      -webkit-user-select:none;
    }
    .row.selected{
      background: var(--accent);
      color:#fff;
    }

    /* Notes app */
    .notes-area{
      width:100%;
      height:100%;
      resize:none;
      font-family: var(--mono);
      font-size:14px;
      line-height:18px;
      padding:10px;
      box-sizing:border-box;
      background: var(--field-bg);
      color: var(--field-text);
      border:1px solid var(--field-border);
      outline:none;
    }
    .notes-wrap{
      height:100%;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .notes-wrap .notes-area{
      flex:1 1 auto;
      min-height:0;
    }

    /* Browser app */
    .browser-wrap{
      height:100%;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .browser-bar{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .browser-bar .field{
      flex:1 1 auto;
      min-width:0;
    }
    .browser-frame{
      flex:1 1 auto;
      min-height:0;
      border:1px solid var(--win-border);
      background:#000;
      overflow:hidden;
    }
    .browser-frame iframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }

    /* App iframe */
    .app-frame{
      width:100%;
      height:100%;
      border:1px solid var(--win-border);
      overflow:hidden;
      background:#000;
    }
    .app-frame iframe{
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }

    /* Modal dialog */
    #modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20000;
      background: rgba(0,0,0,0.35);
      padding:16px;
      box-sizing:border-box;
    }
    #modal.show{ display:flex; }
    .dialog{
      width:min(520px, 92vw);
      background: var(--win-bg);
      border:1px solid var(--win-border);
      box-shadow:
        inset 1px 1px 0 var(--win-highlight),
        inset -1px -1px 0 var(--win-shadow),
        2px 2px 0 rgba(0,0,0,0.25);
      padding:12px;
    }
    .dialog h3{
      margin:0 0 10px 0;
      font-size:16px;
    }
    .dialog .grid{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap:8px;
      align-items:center;
    }
    .dialog .actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      margin-top:12px;
    }
    .readonly{
      opacity:0.9;
      font-family: var(--mono);
    }

    @media (max-width: 520px){
      .menu{ padding:0 8px; }
      .dropdown{ min-width: 200px; }
      .desktop-icon{ width:78px; }
    }
  </style>
</head>

<body>
  <div id="desktop">
    <div id="menubar">
      <div class="menu-left">
        <div class="menu" data-menu="hedgehog" title="Hedgey">
          <span class="logo">ðŸ¦”</span>
          <div class="dropdown">
            <div class="item" data-action="fullscreen">Full Screen</div>
            <div class="sep"></div>
            <div class="item disabled">HedgeyOS</div>
          </div>
        </div>

        <div class="menu" data-menu="file">File
          <div class="dropdown">
            <div class="item" data-action="new-files">New Files Window</div>
            <div class="item" data-action="new-notes">New Notes</div>
            <div class="item" data-action="new-browser">New Browser</div>
          </div>
        </div>

        <div class="menu" data-menu="apps">Apps
          <div class="dropdown" id="appsDropdown"></div>
        </div>
      </div>

      <div class="menu-right">
        <div class="toggle-btn" id="darkToggle" title="Dark mode">â˜¾</div>
      </div>
    </div>

    <div id="desktop-icons"></div>
    <div id="windows"></div>
  </div>

  <div id="modal" aria-hidden="true">
    <div class="dialog">
      <h3>Add New App to HedgeyOS?</h3>
      <div class="grid">
        <div>App Name:</div>
        <input class="field" id="dlgName" placeholder="My App" />

        <div>URL:</div>
        <div class="field readonly" id="dlgUrl"></div>
      </div>
      <div class="actions">
        <div class="btn" id="dlgNo">No</div>
        <div class="btn" id="dlgYes">Yes</div>
      </div>
    </div>
  </div>

  <script type="module">
    /**
     * embedify.js
     * Convert common media URLs into iframe-embed endpoints.
     *
     * Works in browser or Node (Node 18+ for URL).
     *
     * Usage:
     *   const r = toEmbedUrl("https://youtu.be/Oq9JXXrhOt8?si=xxx");
     *   if (r.ok) iframe.src = r.embedUrl;
     */

    function safeURL(input) {
      try {
        // Allow bare domains like "youtube.com/watch?v=..." by forcing scheme
        const trimmed = String(input || "").trim();
        if (!trimmed) return null;

        // If it already looks like a URL but missing scheme, prepend https://
        const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(trimmed);
        const maybeUrl = hasScheme ? trimmed : `https://${trimmed}`;
        return new URL(maybeUrl);
      } catch {
        return null;
      }
    }

    function normHost(hostname) {
      return hostname.toLowerCase().replace(/^www\./, "");
    }

    function pickFirstNonEmpty(...vals) {
      for (const v of vals) {
        if (typeof v === "string" && v.trim()) return v.trim();
      }
      return "";
    }

    /**
     * Extract YouTube video id from multiple URL formats.
     */
    function parseYouTube(u) {
      const host = normHost(u.hostname);
      const path = u.pathname;

      // youtu.be/<id>
      if (host === "youtu.be") {
        const id = path.split("/").filter(Boolean)[0] || "";
        return id ? { id } : null;
      }

      // youtube.com/watch?v=<id>
      if (host === "youtube.com" || host === "m.youtube.com" || host === "music.youtube.com") {
        const v = u.searchParams.get("v");
        if (v) return { id: v };

        // youtube.com/embed/<id>
        if (path.startsWith("/embed/")) {
          const id = path.split("/")[2] || "";
          return id ? { id } : null;
        }

        // youtube.com/shorts/<id>
        if (path.startsWith("/shorts/")) {
          const id = path.split("/")[2] || "";
          return id ? { id } : null;
        }

        // youtube.com/live/<id>
        if (path.startsWith("/live/")) {
          const id = path.split("/")[2] || "";
          return id ? { id } : null;
        }
      }

      return null;
    }

    /**
     * Extract Vimeo id from vimeo.com/<id> or player.vimeo.com/video/<id>.
     */
    function parseVimeo(u) {
      const host = normHost(u.hostname);
      const parts = u.pathname.split("/").filter(Boolean);

      if (host === "vimeo.com") {
        // vimeo.com/<id>
        const id = parts[0] || "";
        return /^\d+$/.test(id) ? { id } : null;
      }

      if (host === "player.vimeo.com") {
        // player.vimeo.com/video/<id>
        if (parts[0] === "video" && /^\d+$/.test(parts[1] || "")) {
          return { id: parts[1] };
        }
      }

      return null;
    }

    /**
     * Spotify: supports track/album/playlist/episode/show
     * Examples:
     *  https://open.spotify.com/track/<id>
     *  spotify:track:<id>
     */
    function parseSpotify(input, u) {
      const raw = String(input || "").trim();

      // spotify URI form
      if (raw.toLowerCase().startsWith("spotify:")) {
        // spotify:track:<id>
        const parts = raw.split(":");
        if (parts.length >= 3) {
          const type = parts[1];
          const id = parts[2];
          if (type && id) return { type, id };
        }
        return null;
      }

      const host = normHost(u.hostname);
      if (host !== "open.spotify.com") return null;

      const parts = u.pathname.split("/").filter(Boolean);
      const type = parts[0] || "";
      const id = parts[1] || "";
      if (!type || !id) return null;

      const allowed = new Set(["track", "album", "playlist", "episode", "show", "artist"]);
      if (!allowed.has(type)) return null;

      return { type, id };
    }

    /**
     * SoundCloud: official embed is via w.soundcloud.com/player?url=<encoded original url>
     * We'll accept soundcloud.com/* and on.soundcloud.com/*
     */
    function parseSoundCloud(u) {
      const host = normHost(u.hostname);
      if (host === "soundcloud.com" || host === "on.soundcloud.com") {
        return { original: u.toString() };
      }
      return null;
    }

    /**
     * Twitch:
     * - Clips: https://clips.twitch.tv/<slug>
     * - Videos: https://www.twitch.tv/videos/<id>
     * - Channels: https://www.twitch.tv/<channel>
     * Embed requires a "parent" domain param. Caller must supply.
     */
    function parseTwitch(u) {
      const host = normHost(u.hostname);
      const parts = u.pathname.split("/").filter(Boolean);

      if (host === "clips.twitch.tv") {
        const slug = parts[0] || "";
        return slug ? { kind: "clip", slug } : null;
      }

      if (host === "twitch.tv" || host === "www.twitch.tv" || host === "m.twitch.tv") {
        if (parts[0] === "videos" && parts[1]) {
          return { kind: "video", id: parts[1] };
        }
        // channel
        if (parts[0]) return { kind: "channel", channel: parts[0] };
      }

      return null;
    }

    /**
     * Loom:
     * https://www.loom.com/share/<id> -> https://www.loom.com/embed/<id>
     */
    function parseLoom(u) {
      const host = normHost(u.hostname);
      const parts = u.pathname.split("/").filter(Boolean);
      if (host !== "loom.com") return null;

      if (parts[0] === "share" && parts[1]) return { id: parts[1] };
      if (parts[0] === "embed" && parts[1]) return { id: parts[1] };
      return null;
    }

    /**
     * Google Drive file:
     * https://drive.google.com/file/d/<id>/view -> https://drive.google.com/file/d/<id>/preview
     * Also accepts /open?id=<id>
     */
    function parseGDrive(u) {
      const host = normHost(u.hostname);
      if (host !== "drive.google.com") return null;

      const parts = u.pathname.split("/").filter(Boolean);
      // /file/d/<id>/...
      if (parts[0] === "file" && parts[1] === "d" && parts[2]) {
        return { id: parts[2] };
      }
      // /open?id=<id>
      const id = u.searchParams.get("id");
      if (id) return { id };
      return null;
    }

    /**
     * Google Docs/Slides embed-ish:
     * - Docs: /document/d/<id>/edit -> /document/d/<id>/preview
     * - Slides: /presentation/d/<id>/edit -> /presentation/d/<id>/embed
     * - Sheets: /spreadsheets/d/<id>/edit -> /spreadsheets/d/<id>/preview
     */
    function parseGoogleDocs(u) {
      const host = normHost(u.hostname);
      if (host !== "docs.google.com") return null;

      const parts = u.pathname.split("/").filter(Boolean);
      // e.g. document/d/<id>/edit
      const kind = parts[0];
      if (!["document", "presentation", "spreadsheets", "forms"].includes(kind)) return null;
      if (parts[1] !== "d" || !parts[2]) return null;

      return { kind, id: parts[2] };
    }

    /**
     * Main converter.
     * Options:
     * - twitchParent: required by Twitch embed URLs. Example: "example.com"
     */
    export function toEmbedUrl(entryText, options = {}) {
      const input = String(entryText || "").trim();
      if (!input) return { ok: false, reason: "empty" };

      const u = safeURL(input);
      if (!u) return { ok: false, reason: "not_a_url" };

      const host = normHost(u.hostname);

      // YouTube
      const yt = parseYouTube(u);
      if (yt) {
        // Preserve start time if present: t=123 or start=123
        const t = pickFirstNonEmpty(u.searchParams.get("start"), u.searchParams.get("t"));
        const start = t ? String(parseInt(t, 10) || "") : "";
        const embed = new URL(`https://www.youtube.com/embed/${yt.id}`);
        if (start) embed.searchParams.set("start", start);
        return { ok: true, provider: "youtube", embedUrl: embed.toString() };
      }

      // Vimeo
      const vm = parseVimeo(u);
      if (vm) {
        return { ok: true, provider: "vimeo", embedUrl: `https://player.vimeo.com/video/${vm.id}` };
      }

      // Spotify
      const sp = parseSpotify(input, u);
      if (sp) {
        return { ok: true, provider: "spotify", embedUrl: `https://open.spotify.com/embed/${sp.type}/${sp.id}` };
      }

      // SoundCloud
      const sc = parseSoundCloud(u);
      if (sc) {
        const embed = new URL("https://w.soundcloud.com/player/");
        embed.searchParams.set("url", sc.original);
        return { ok: true, provider: "soundcloud", embedUrl: embed.toString() };
      }

      // Twitch (needs parent)
      const tw = parseTwitch(u);
      if (tw) {
        const parent = String(options.twitchParent || "").trim();
        if (!parent) {
          return { ok: false, reason: "twitch_requires_parent", provider: "twitch" };
        }
        const embed = new URL("https://player.twitch.tv/");
        embed.searchParams.set("parent", parent);

        if (tw.kind === "clip") embed.searchParams.set("clip", tw.slug);
        if (tw.kind === "video") embed.searchParams.set("video", tw.id);
        if (tw.kind === "channel") embed.searchParams.set("channel", tw.channel);

        return { ok: true, provider: "twitch", embedUrl: embed.toString() };
      }

      // Loom
      const lo = parseLoom(u);
      if (lo) {
        return { ok: true, provider: "loom", embedUrl: `https://www.loom.com/embed/${lo.id}` };
      }

      // Google Drive file preview
      const gd = parseGDrive(u);
      if (gd) {
        return { ok: true, provider: "gdrive", embedUrl: `https://drive.google.com/file/d/${gd.id}/preview` };
      }

      // Google Docs/Slides/Sheets "preview/embed"
      const gdocs = parseGoogleDocs(u);
      if (gdocs) {
        if (gdocs.kind === "presentation") {
          return { ok: true, provider: "gslides", embedUrl: `https://docs.google.com/presentation/d/${gdocs.id}/embed` };
        }
        if (gdocs.kind === "document") {
          return { ok: true, provider: "gdocs", embedUrl: `https://docs.google.com/document/d/${gdocs.id}/preview` };
        }
        if (gdocs.kind === "spreadsheets") {
          return { ok: true, provider: "gsheets", embedUrl: `https://docs.google.com/spreadsheets/d/${gdocs.id}/preview` };
        }
        // Forms embedding is a different endpoint; keep as-is if already /viewform, else try /viewform
        if (gdocs.kind === "forms") {
          // Many forms already have /viewform; embed param is embedded=true
          const embed = new URL(`https://docs.google.com/forms/d/${gdocs.id}/viewform`);
          embed.searchParams.set("embedded", "true");
          return { ok: true, provider: "gforms", embedUrl: embed.toString() };
        }
      }

      return { ok: false, reason: "unsupported_host", host };
    }

    /**
     * Convenience: returns embedUrl string or null
     */
    export function embedUrlOrNull(entryText, options = {}) {
      const r = toEmbedUrl(entryText, options);
      return r.ok ? r.embedUrl : null;
    }

    // HedgeyOS core
    (() => {
      const $ = (sel, el=document) => el.querySelector(sel);
      const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

      const LS_THEME = "hedgeyos.theme";
      const LS_NOTES = "hedgeyos.notes.text";
      const LS_SAVED_APPS = "hedgeyos.savedApps";
      const LS_FIRST_BOOT = "hedgeyos.didBoot";

      const desktop = $("#desktop");
      const windowsEl = $("#windows");
      const iconsEl = $("#desktop-icons");
      const appsDropdown = $("#appsDropdown");

      const modal = $("#modal");
      const dlgName = $("#dlgName");
      const dlgUrl = $("#dlgUrl");
      const dlgYes = $("#dlgYes");
      const dlgNo = $("#dlgNo");

      const darkToggle = $("#darkToggle");

      const DEFAULT_NOTES_TEXT = "HedgeyOS was made by Decentricity. Follow me on X!";

      const defaultApps = {
        "flipside-classic": { title:"Flipside classic", url:"https://flipside.ink" },
        "flipside-3d": { title:"Flipside 3D", url:"https://cubewalker.berrry.app" },
        "unconnected-chat": { title:"Unconnected AI Chat", url:"https://chat.unconnected.ai" },
        "hedgey-town": { title:"3D Hedgey Town", url:"https://blueprintwalk.berrry.app/" },
        "chordynaut": { title:"Chordynaut", url:"https://chordynaut.com" },
        "about": { title:"About", url:"https://decentricity.github.io" },

        "terminal": { title:"DecenTerminal", url:"https://decentricityos.berrry.app/" },
        "python": { title:"PythonCity", url:"https://pythoncity.berrry.app/" },
        "ocean": { title:"OceanBoat", url:"https://oceanshader.berrry.app/" },
        "tetris": { title:"3dTetris", url:"https://tetris3d.berrry.app/" },
      };

      const parodyFiles = [
        "Hedgehog",
        "Pig",
        "Boarbarian",
        "Flipside",
        "Lina",
        "Decentricity",
        "Ms. Pandu Sastrowardoyo",
        "inversebrah",
        "Danceu",
        "Fren",
        "HedgeyTown",
        "Chordynaut",
        "Unconnected",
        "SufferMon",
        "GunDB",
        "Pandan Studios",
        "myriad.social",
        "debio.ai",
      ];

      let zTop = 30;
      let winSeq = 0;

      const state = {
        windows: new Map(),
        activeId: null,
        browserCurrentUrl: "https://decentricity.github.io",
        pendingSaveFromBrowserId: null,
      };

      function clampPartial(v, min, max){ return Math.min(max, Math.max(min, v)); }

      function setTheme(theme){
        document.documentElement.setAttribute("data-theme", theme);
        localStorage.setItem(LS_THEME, theme);
        darkToggle.textContent = (theme === "dark") ? "â˜€" : "â˜¾";
        layoutIcons();
      }

      function loadTheme(){
        const saved = localStorage.getItem(LS_THEME);
        setTheme(saved === "dark" ? "dark" : "light");
      }

      function showModal(){
        modal.classList.add("show");
        modal.setAttribute("aria-hidden","false");
      }
      function hideModal(){
        modal.classList.remove("show");
        modal.setAttribute("aria-hidden","true");
        state.pendingSaveFromBrowserId = null;
      }

      function savedAppsLoad(){
        try{
          const raw = localStorage.getItem(LS_SAVED_APPS);
          if(!raw) return [];
          const arr = JSON.parse(raw);
          if(!Array.isArray(arr)) return [];
          return arr.filter(x => x && typeof x.title==="string" && typeof x.url==="string");
        }catch(_){ return []; }
      }
      function savedAppsStore(arr){
        localStorage.setItem(LS_SAVED_APPS, JSON.stringify(arr));
      }

      function buildAppsMenu(){
        const saved = savedAppsLoad();

        const openWins = Array.from(state.windows.values())
          .map(w => ({ id: w.id, title: w.title }));

        const mk = (label, action, extra={}) => {
          const div = document.createElement("div");
          div.className = "item";
          div.textContent = label;
          div.dataset.action = action;
          Object.assign(div.dataset, extra);
          return div;
        };

        appsDropdown.innerHTML = "";

        appsDropdown.appendChild(document.createElement("div")).className="heading";
        appsDropdown.lastChild.textContent = "Core";

        appsDropdown.appendChild(mk("Files", "open-core", { core:"files" }));
        appsDropdown.appendChild(mk("Notes", "open-core", { core:"notes" }));
        appsDropdown.appendChild(mk("Browser", "open-core", { core:"browser" }));

        const sep1 = document.createElement("div"); sep1.className="sep"; appsDropdown.appendChild(sep1);

        appsDropdown.appendChild(document.createElement("div")).className="heading";
        appsDropdown.lastChild.textContent = "Apps";

        Object.entries(defaultApps).forEach(([key, app]) => {
          appsDropdown.appendChild(mk(app.title, "open-app", { app:key }));
        });

        const sep2 = document.createElement("div"); sep2.className="sep"; appsDropdown.appendChild(sep2);

        appsDropdown.appendChild(document.createElement("div")).className="heading";
        appsDropdown.lastChild.textContent = "Saved Apps";

        if(saved.length === 0){
          const d = document.createElement("div");
          d.className="item disabled";
          d.textContent="(none yet)";
          appsDropdown.appendChild(d);
        } else {
          saved.forEach((app, idx) => {
            appsDropdown.appendChild(mk(app.title, "open-saved-app", { idx:String(idx) }));
          });
        }

        const sep3 = document.createElement("div"); sep3.className="sep"; appsDropdown.appendChild(sep3);

        appsDropdown.appendChild(document.createElement("div")).className="heading";
        appsDropdown.lastChild.textContent = "Open Windows";

        if(openWins.length === 0){
          const d = document.createElement("div");
          d.className="item disabled";
          d.textContent="(none)";
          appsDropdown.appendChild(d);
        } else {
          openWins.forEach(w => {
            appsDropdown.appendChild(mk(w.title, "focus-window", { id:w.id }));
          });
        }
      }

      function closeAllMenus(){
        $$(".menu").forEach(m => m.classList.remove("active"));
      }

      function setupMenus(){
        $$(".menu").forEach(menu => {
          menu.addEventListener("pointerdown", (e) => {
            e.preventDefault();
            const isActive = menu.classList.contains("active");
            closeAllMenus();
            if(!isActive) menu.classList.add("active");
          });
        });

        document.addEventListener("pointerdown", (e) => {
          const inMenu = e.target.closest && e.target.closest(".menu");
          if(!inMenu && !modal.classList.contains("show")){
            closeAllMenus();
          }
        });

        desktop.addEventListener("pointerdown", (e) => {
          if(e.target === windowsEl || e.target === iconsEl || e.target === desktop){
            closeAllMenus();
          }
        });

        desktop.addEventListener("click", (e) => {
          const item = e.target.closest && e.target.closest(".item");
          if(!item) return;

          const action = item.dataset.action;
          if(!action) return;

          closeAllMenus();

          if(action === "fullscreen"){
            toggleFullscreen();
            return;
          }
          if(action === "new-files"){ openFilesWindow(); return; }
          if(action === "new-notes"){ openNotesWindow(); return; }
          if(action === "new-browser"){ openBrowserWindow(); return; }

          if(action === "open-core"){
            const core = item.dataset.core;
            if(core === "files") openFilesWindow();
            if(core === "notes") openNotesWindow();
            if(core === "browser") openBrowserWindow();
            return;
          }

          if(action === "open-app"){
            const key = item.dataset.app;
            const app = defaultApps[key];
            if(app) openAppWindow(app.title, app.url, key);
            return;
          }

          if(action === "open-saved-app"){
            const idx = Number(item.dataset.idx);
            const saved = savedAppsLoad();
            const app = saved[idx];
            if(app) openAppWindow(app.title, app.url, "saved:"+idx);
            return;
          }

          if(action === "focus-window"){
            const id = item.dataset.id;
            if(id) focusWindow(id);
            return;
          }
        });

        darkToggle.addEventListener("click", () => {
          const cur = document.documentElement.getAttribute("data-theme") || "light";
          setTheme(cur === "dark" ? "light" : "dark");
        });
      }

      function toggleFullscreen(){
        const el = document.documentElement;
        if(!document.fullscreenElement){
          el.requestFullscreen?.();
        } else {
          document.exitFullscreen?.();
        }
      }

      function nextWindowRect(){
        const vw = window.innerWidth;
        const vh = window.innerHeight - parseInt(getComputedStyle(document.documentElement).getPropertyValue("--menubar-h"), 10);

        const w = Math.max(280, Math.floor(vw * 0.80));
        const h = Math.max(220, Math.floor(vh * 0.50));

        const pad = 12;
        const offset = 22 * (winSeq % 10);
        const x = pad + offset;
        const y = pad + offset;

        winSeq++;
        return { x, y, w, h };
      }

      function makeWindowShell(title){
        const id = "w" + Math.random().toString(36).slice(2,10);

        const win = document.createElement("div");
        win.className = "window";
        win.dataset.id = id;

        const r = nextWindowRect();
        win.style.left = r.x + "px";
        win.style.top = r.y + "px";
        win.style.width = r.w + "px";
        win.style.height = r.h + "px";
        win.style.zIndex = (++zTop).toString();

        const tb = document.createElement("div");
        tb.className = "titlebar";
        tb.innerHTML = `
          <div class="controls">
            <div class="ctrl"></div>
            <div class="ctrl"></div>
          </div>
          <div class="center-title">
            <div class="lines">
              <div class="lineblock"></div>
              <div class="lineblock"></div>
            </div>
            <div class="title-text"></div>
          </div>
          <div style="width:18px"></div>
        `;
        $(".title-text", tb).textContent = title;

        const inner = document.createElement("div");
        inner.className = "window-inner";

        const body = document.createElement("div");
        body.className = "window-body";

        const status = document.createElement("div");
        status.className = "statusbar";
        status.innerHTML = `<div>Ready.</div><div>Finder-ish</div>`;

        const handle = document.createElement("div");
        handle.className = "resize-handle";
        handle.title = "Resize";

        inner.appendChild(body);
        inner.appendChild(status);

        win.appendChild(tb);
        win.appendChild(inner);
        win.appendChild(handle);

        win.addEventListener("pointerdown", () => focusWindow(id));

        enableDrag(win, tb);
        enableResize(win, handle);

        windowsEl.appendChild(win);

        return { id, win, body, titleEl: $(".title-text", tb), statusEl: status };
      }

      function focusWindow(id){
        const w = state.windows.get(id);
        if(!w) return;
        state.activeId = id;

        w.el.style.zIndex = (++zTop).toString();

        state.windows.forEach((v) => v.el.classList.add("inactive"));
        w.el.classList.remove("inactive");
      }

      function enableDrag(win, handleEl){
        let dragging = false;
        let startX=0, startY=0, startLeft=0, startTop=0;

        handleEl.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          dragging = true;
          win.setPointerCapture(e.pointerId);

          const rect = win.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          startLeft = rect.left;
          startTop = rect.top;

          focusWindow(win.dataset.id);
        });

        win.addEventListener("pointermove", (e) => {
          if(!dragging) return;

          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          const vw = window.innerWidth;
          const vh = window.innerHeight;

          const rect = win.getBoundingClientRect();
          const w = rect.width;
          const h = rect.height;

          const minVisible = 32;
          const minX = -(w - minVisible);
          const maxX = vw - minVisible;
          const minY = -(h - minVisible);
          const maxY = vh - minVisible;

          const newLeft = clampPartial(startLeft + dx, minX, maxX);
          const newTop = clampPartial(startTop + dy, minY, maxY);

          win.style.left = newLeft + "px";
          win.style.top = newTop + "px";
        });

        win.addEventListener("pointerup", (e) => {
          if(!dragging) return;
          dragging = false;
          try { win.releasePointerCapture(e.pointerId); } catch(_){}
          layoutIcons();
        });
      }

      function enableResize(win, handleEl){
        let resizing = false;
        let startX=0, startY=0, startW=0, startH=0;

        handleEl.addEventListener("pointerdown", (e) => {
          e.preventDefault();
          resizing = true;
          win.setPointerCapture(e.pointerId);

          const rect = win.getBoundingClientRect();
          startX = e.clientX;
          startY = e.clientY;
          startW = rect.width;
          startH = rect.height;

          focusWindow(win.dataset.id);
        });

        win.addEventListener("pointermove", (e) => {
          if(!resizing) return;
          const dx = e.clientX - startX;
          const dy = e.clientY - startY;

          const minW = 260;
          const minH = 180;

          const newW = Math.max(minW, Math.floor(startW + dx));
          const newH = Math.max(minH, Math.floor(startH + dy));

          win.style.width = newW + "px";
          win.style.height = newH + "px";
        });

        win.addEventListener("pointerup", (e) => {
          if(!resizing) return;
          resizing = false;
          try { win.releasePointerCapture(e.pointerId); } catch(_){}
          layoutIcons();
        });
      }

      function iconEmojiForWindow(w){
        if(w.type === "files") return "ðŸ“‚";
        if(w.type === "notes") return "ðŸ“‘";
        return "ðŸ“”";
      }

      function layoutIcons(){
        iconsEl.innerHTML = "";

        const open = Array.from(state.windows.values());

        const inset = 12;
        const startX = inset;
        const startY = (window.innerHeight - inset) - 86;
        const stepX = 90;
        const stepY = 92;

        let col = 0, row = 0;

        open.forEach(w => {
          const icon = document.createElement("div");
          icon.className = "desktop-icon";
          icon.dataset.id = w.id;

          icon.innerHTML = `
            <div class="emoji">${iconEmojiForWindow(w)}</div>
            <div class="label"></div>
          `;
          $(".label", icon).textContent = w.title;

          const x = startX + (col * stepX);
          const y = startY - (row * stepY);

          icon.style.left = x + "px";
          icon.style.top = y + "px";

          icon.addEventListener("click", (e) => {
            e.stopPropagation();
            focusWindow(w.id);
          });

          iconsEl.appendChild(icon);

          col++;
          if(x + stepX + 90 > window.innerWidth){
            col = 0;
            row++;
          }
        });
      }

      function openFilesWindow(){
        const shell = makeWindowShell("Files");
        const { id, win, body } = shell;

        body.innerHTML = `
          <div class="files-wrap">
            <div class="files-toolbar">
              <div class="btn">New Window</div>
              <div class="btn">Sort</div>
              <div class="btn">View</div>
            </div>
            <div class="files-grid">
              <div class="files-header">
                <div class="col-name">Name</div>
              </div>
              <div class="files-list" id="filesList"></div>
            </div>
          </div>
        `;

        const list = $("#filesList", body);
        parodyFiles.forEach((name, i) => {
          const row = document.createElement("div");
          row.className = "row" + (i === 0 ? " selected" : "");
          row.textContent = name;
          row.addEventListener("click", () => {
            $$(".row", list).forEach(r => r.classList.remove("selected"));
            row.classList.add("selected");
          });
          list.appendChild(row);
        });

        state.windows.set(id, { id, type:"files", title:"Files", el:win });
        focusWindow(id);
        buildAppsMenu();
        layoutIcons();

        return id;
      }

      function openNotesWindow(opts={}){
        const shell = makeWindowShell(opts.title || "Notes");
        const { id, win, body } = shell;

        body.innerHTML = `
          <div class="notes-wrap">
            <textarea class="notes-area" id="notesArea" spellcheck="false"></textarea>
          </div>
        `;

        const area = $("#notesArea", body);

        const saved = localStorage.getItem(LS_NOTES);
        if(saved != null){
          area.value = saved;
        } else {
          area.value = (opts.prefill != null) ? opts.prefill : "";
        }

        let t = null;
        area.addEventListener("input", () => {
          if(t) clearTimeout(t);
          t = setTimeout(() => {
            localStorage.setItem(LS_NOTES, area.value);
          }, 1000);
        });

        state.windows.set(id, { id, type:"notes", title: opts.title || "Notes", el:win });
        focusWindow(id);
        buildAppsMenu();
        layoutIcons();

        return id;
      }

      function normalizeUserUrl(raw){
        const u = safeURL(raw);
        return u ? u.toString() : String(raw || "").trim();
      }

      function openBrowserWindow(){
        const shell = makeWindowShell("Browser");
        const { id, win, body } = shell;

        const initial = state.browserCurrentUrl || "https://decentricity.github.io";

        body.innerHTML = `
          <div class="browser-wrap">
            <div class="browser-bar">
              <input class="field" id="urlField" placeholder="https://..." />
              <div class="btn" id="goBtn">Go</div>
              <div class="btn" id="saveBtn">Save</div>
            </div>
            <div class="browser-frame">
              <iframe id="browserFrame" sandbox="allow-scripts allow-forms allow-same-origin allow-pointer-lock allow-popups"></iframe>
            </div>
          </div>
        `;

        const urlField = $("#urlField", body);
        const goBtn = $("#goBtn", body);
        const saveBtn = $("#saveBtn", body);
        const frame = $("#browserFrame", body);

        function nav(url){
          state.browserCurrentUrl = url;
          urlField.value = url;
          frame.src = url;
        }

        function go(){
          const raw = (urlField.value || "").trim();
          if(!raw) return;

          const normalized = normalizeUserUrl(raw);

          const r = toEmbedUrl(normalized, { twitchParent: location.hostname });

          const finalUrl = r.ok ? r.embedUrl : normalized;

          urlField.value = finalUrl;
          nav(finalUrl);
        }

        goBtn.addEventListener("click", go);
        urlField.addEventListener("keydown", (e) => {
          if(e.key === "Enter") go();
        });

        urlField.value = initial;
        frame.src = initial;

        saveBtn.addEventListener("click", () => {
          const current = (urlField.value || "").trim() || state.browserCurrentUrl;
          if(!current) return;

          state.pendingSaveFromBrowserId = id;
          dlgName.value = "";
          dlgUrl.textContent = current;
          showModal();
          dlgName.focus();
        });

        state.windows.set(id, { id, type:"browser", title:"Browser", el:win });
        focusWindow(id);
        buildAppsMenu();
        layoutIcons();

        return id;
      }

      function openAppWindow(title, url, appKey){
        const shell = makeWindowShell(title);
        const { id, win, body } = shell;

        body.innerHTML = `
          <div class="app-frame">
            <iframe sandbox="allow-scripts allow-forms allow-same-origin allow-pointer-lock allow-popups" src="${escapeHtml(url)}"></iframe>
          </div>
        `;

        state.windows.set(id, { id, type:"app", title, el:win, appKey, url });
        focusWindow(id);
        buildAppsMenu();
        layoutIcons();

        return id;
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      dlgNo.addEventListener("click", hideModal);
      modal.addEventListener("pointerdown", (e) => {
        if(e.target === modal) hideModal();
      });

      dlgYes.addEventListener("click", () => {
        const name = (dlgName.value || "").trim();
        const url = (dlgUrl.textContent || "").trim();
        if(!name || !url){ hideModal(); return; }

        const saved = savedAppsLoad();
        saved.push({ title:name, url });
        savedAppsStore(saved);

        hideModal();
        buildAppsMenu();
      });

      window.addEventListener("resize", () => {
        layoutIcons();
      });

      function firstBoot(){
        const did = localStorage.getItem(LS_FIRST_BOOT);
        if(did) return;

        openFilesWindow();
        openNotesWindow({ title:"Notes", prefill: DEFAULT_NOTES_TEXT });

        localStorage.setItem(LS_FIRST_BOOT, "1");
      }

      function normalBoot(){
        openFilesWindow();
      }

      loadTheme();
      setupMenus();
      buildAppsMenu();

      if(localStorage.getItem(LS_FIRST_BOOT)){
        normalBoot();
        const savedNotes = localStorage.getItem(LS_NOTES);
        if(savedNotes && savedNotes.trim()){
          openNotesWindow({ title:"Notes" });
        }
      } else {
        firstBoot();
      }

      setTimeout(layoutIcons, 0);

      desktop.addEventListener("dragstart", (e) => e.preventDefault());
    })();
  </script>
</body>
</html>
